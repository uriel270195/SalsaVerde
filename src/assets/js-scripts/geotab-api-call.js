var GeotabApi=function(n,t,i){"use strict";var f="geotabJSONP",u,e,c=[],r={rememberMe:!0,debug:!1,jsonp:!1,timeout:0},o,s=function(){if(r.debug){var n=[new Date];n.push.apply(n,arguments);console.log.apply(console,n)}},h=function(n,t,i){var u;if(n&&n.name&&n.message?(n.message==="DbUnavailable"&&(n.message="Database is not available."),u=n.message):(n.target||n instanceof XMLHttpRequest&&n.status===0)&&(u="Couldn't connect to the server. Please check your network connection, server name and try again."),r.debug&&console.error(u,n),n&&i){if(typeof i=="string")try{i=JSON.parse(i)}catch(f){}n.apiCall=b(i)}t&&t(u||"Error",n)},w=function(n){var t=e.replace(/\S*:\/\//,"").replace(/\/$/,"");return"https://"+t+"/apiv1"+(n?"/"+n:"")},l=function(n){var t=document.getElementById(n),i;if(t){t.parentNode.removeChild(t);for(i in t)t.hasOwnProperty(i)&&delete t[i]}delete window[f][n]},g=function(n,t,i,u){var e="json"+(Math.random()*100).toString().replace(/\./g,""),c=function(){var n,i;t=t||{};n=[];for(i in t)t.hasOwnProperty(i)&&n.push.apply(n,["&",encodeURIComponent(i),"=",encodeURIComponent(JSON.stringify(t[i]))]);return n.join("")},o;return window[f][e]=function(r){o&&(clearTimeout(o),o=null);try{if(r&&r.error)s(n,"ERROR",r.error),h(r.error,u,{method:n,params:t});else{var f=r.result;s(n,"SUCCESS",{result:f});i&&i(f)}}finally{l(e)}},document.getElementsByTagName("body")[0].appendChild(function(){var i=document.createElement("script");return i.type="text/javascript",i.id=e,i.async="async",i.src=w(n)+"?JSONP="+f+"."+e+c(),i.onerror=function(i){try{s("CallJSONP",n,"ERROR",i);h(i,u,{method:n,params:t})}finally{l(e)}},i}()),o&&clearTimeout(o),r.timeout&&n!=="Authenticate"&&(o=setTimeout(function(){window[f].hasOwnProperty(e)&&(window[f][e]({error:{name:"JSONPTimeout",message:"Could not complete the JSONP request in a timely manner ("+r.timeout+"s)",target:document.getElementById(e)}}),window[f][e]=function(){l(e)})},r.timeout*1e3)),{abort:function(){l(e);errorCallback&&errorCallback("Cancelled",{})}}},b=function(n){return n&&Object.keys(n).forEach(function(t){t==="credentials"?delete n[t]:(t.toLowerCase().indexOf("password")>-1&&typeof n[t]=="string"&&(n[t]=n[t].replace(/./g,"*")),typeof n[t]=="object"&&b(n[t]))}),n},nt=function(n,t,i,u){var f=new XMLHttpRequest,e;f.open("POST",w(),!0);f.setRequestHeader("Content-Type","application/x-www-form-urlencoded");f.addEventListener("abort",function(n){u&&u("Cancelled",n)});f.onreadystatechange=function(){if(f.readyState===4)if(f.status===200){var t,r,o;try{t=JSON.parse(f.responseText);t&&t.error?(r=t.error,s(n,"ERROR",r),h(r,u,e||null)):(o=t.result,s(n,"SUCCESS",{result:o}),i(o))}catch(c){h(c,u,e||null)}}else s(n,"ERROR",f),h(f,u,e||null)};try{e=JSON.stringify({method:n||"",params:t})}catch(o){h(o,u);return}return r.timeout&&(f.timeout=r.timeout*1e3),f.send("JSON-RPC="+encodeURIComponent(e)),{abort:function(){f.abort()}}},k=function(n,t,i,u){return r.jsonp?g(n,t,i,u):nt(n,t,i,u)},tt=function(n,t,i,f,s,h){return e=n,k("Authenticate",{database:t,userName:i,password:f},function(n){n.path&&n.path!=="ThisServer"&&(e="https://"+n.path+"/");u=n.credentials;r.rememberMe&&o.set(u,e);s&&s(u)},h)},y=function(t){n(function(n,i,r,u,f,e){return tt(n,i,r,u,function(n){f&&f();t&&t(n);c.forEach(function(n){a.apply(this,n)});c=[]},e)})},p=function(){var n=[],t=function(t){n.push(t)},i=function(t){n=n.filter(function(n){return n!==t})},r=function(){n.forEach(function(n){n&&n.abort&&n.abort()});n=[]};return{add:t,remove:i,abort:r}}(),a=function(n,t,i,f){var h=function(){c.push([n,t,i,f]);var s=o.get();s&&r.rememberMe?(u=s.credentials,e=s.server,c.forEach(function(n){a.apply(this,n)}),c=[]):y()},s;return(i=i||r.defaultSuccessCallback,f=f||r.defaultErrorCallback,!u)?(h(),{abort:function(){}}):(t.credentials=u,s=k(n,t,i,function(t,i){var r=i.errors;p.remove(s);s=null;r&&r[0]&&r[0].name==="InvalidUserException"&&n!=="Authenticate"?(o.clear(!0),h()):f&&f(t,i)}),p.add(s),s)},it=function(n,t,i){var r=n.map(function(n){var t=n[1];return{method:n[0],params:t}});return a("ExecuteMultiCall",{calls:r},t,i)},rt=function(n,t){var i=o.get();if(!t&&i&&r.rememberMe){n&&n(i.credentials,i.server);return}y(function(){n&&n(u,e)})},ut=function(n){u=null;o.clear();y(n||null)},ft=function(n,t){r.defaultSuccessCallback=n;r.defaultErrorCallback=t},v,d;if(t)for(v in t)t.hasOwnProperty(v)&&(r[v]=t[v]);return window[f]={},d={CREDENTIALS_KEY:"geotabAPI_credentials",SERVER_KEY:"geotabAPI_server",POSSIBLE_CREDENTIALS_KEY:"sTokens_geotabdemo",get:function(){var n=localStorage.getItem(this.CREDENTIALS_KEY),t=localStorage.getItem(this.SERVER_KEY),i=!1;if(n&&t||(n=localStorage.getItem(this.POSSIBLE_CREDENTIALS_KEY),n&&(t=window.location.host)),n&&t)try{i={credentials:JSON.parse(n),server:t}}catch(r){return!1}return i},set:function(n,t){localStorage.setItem(this.CREDENTIALS_KEY,JSON.stringify(n));localStorage.setItem(this.SERVER_KEY,t)},clear:function(){localStorage.removeItem(this.CREDENTIALS_KEY);localStorage.removeItem(this.SERVER_KEY);localStorage.removeItem(this.POSSIBLE_CREDENTIALS_KEY)}},o=i||d,{call:a,multiCall:it,abort:p.abort,forget:ut,getSession:rt,setDefaultHandlers:ft}};typeof define!="undefined"&&define.amd&&define(function(){"use strict";return GeotabApi})